---
import HeaderButton from "./HeaderButton.astro";
import { House, Menu, Moon, Sun, Users, X } from "@lucide/astro";
---

<div>
    <aside
        id="sidebar"
        class="fixed top-0 left-0 z-40 h-full w-14 bg-white dark:bg-slate-900 shadow-xl transition-[width] duration-300 flex flex-col"
    >
        <div
            class="flex items-center justify-center h-16 border-b border-gray-200 dark:border-slate-800"
        >
            <button
                id="sidebar-toggle"
                type="button"
                class="flex items-center justify-center p-2 rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-slate-800 transition-colors"
                aria-label="Alternar menú"
                aria-expanded="false"
                aria-controls="sidebar"
            >
                <Menu data-icon="open" size={18} />
                <X data-icon="close" size={18} class="hidden" />
            </button>
        </div>

        <nav class="flex flex-col gap-2 px-2 py-4">
            <HeaderButton href="/">
                <House slot="before" size={24} />
                Inicio
            </HeaderButton>
            <HeaderButton href="/characters">
                <Users slot="before" size={24} />
                Personajes
            </HeaderButton>
        </nav>

        <div
            class="mt-auto px-2 py-4 border-t border-gray-200 dark:border-slate-800"
        >
            <button
                id="theme-toggle"
                type="button"
                class="sidebar-link flex items-center gap-3 w-full rounded-lg px-3 py-2 text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-slate-800 transition-colors justify-center"
                aria-label="Alternar tema"
                aria-pressed="false"
            >
                <Sun class="hidden dark:block" size={18} />
                <Moon class="block dark:hidden" size={18} />
                <span data-label class="text-sm font-medium hidden">Tema</span>
            </button>
        </div>
    </aside>

    <header class="pt-6 pb-8 px-4 mx-auto max-w-2xl lg:pt-10 text-center">
        <h1
            class="mb-3 text-4xl font-bold leading-tight text-gray-900 md:text-4xl dark:text-white"
        >
            Genshin Impact
        </h1>
        <p class="text-gray-500 sm:text-lg dark:text-gray-400">
            Estadísticas de todos los personajes de Genshin Impact
        </p>
    </header>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const themeToggle = document.getElementById("theme-toggle");
        const labels = sidebar?.querySelectorAll("[data-label]");
        const links = sidebar?.querySelectorAll(".sidebar-link");

        if (!sidebar || !sidebarToggle) return;

        const updateMenuIcons = (isOpen: boolean) => {
            const openIcon = sidebarToggle.querySelector('[data-icon="open"]');
            const closeIcon = sidebarToggle.querySelector('[data-icon="close"]');
            openIcon?.classList.toggle("hidden", isOpen);
            closeIcon?.classList.toggle("hidden", !isOpen);
        };

        const setSidebarState = (isOpen: boolean) => {
            sidebar.classList.toggle("w-14", !isOpen);
            sidebar.classList.toggle("w-64", isOpen);
            labels?.forEach((label) => {
                label.classList.toggle("hidden", !isOpen);
            });
            links?.forEach((link) => {
                link.classList.toggle("justify-center", !isOpen);
                link.classList.toggle("justify-start", isOpen);
            });
            sidebarToggle.setAttribute("aria-expanded", String(isOpen));
            updateMenuIcons(isOpen);
        };

        const closeSidebar = () => setSidebarState(false);
        const toggleSidebar = () => {
            const isOpen = sidebar.classList.contains("w-64");
            setSidebarState(!isOpen);
        };

        setSidebarState(false);

        sidebarToggle.addEventListener("click", toggleSidebar);
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") closeSidebar();
        });

        sidebar
            .querySelectorAll("a[href]")
            .forEach((link) => link.addEventListener("click", closeSidebar));

        if (themeToggle) {
            const syncThemeState = () => {
                const isDark = document.documentElement.classList.contains("dark");
                themeToggle.setAttribute("aria-pressed", String(isDark));
            };

            syncThemeState();
            themeToggle.addEventListener("click", () => {
                const isDark = document.documentElement.classList.toggle("dark");
                try {
                    localStorage.setItem("theme", isDark ? "dark" : "light");
                } catch (_) {}
                themeToggle.setAttribute("aria-pressed", String(isDark));
            });
        }
    });
</script>
